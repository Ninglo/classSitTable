<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç­çº§åº§ä½å®‰æ’å·¥å…·</title>
  <style>
    @font-face {
      font-family: 'Smiley Sans';
      font-style: normal;
      font-display: swap;
      src: url('./SmileySans-Oblique.woff2') format('woff2');
    }

    * {
      font-family: 'Smiley Sans', sans-serif;
    }

    body {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .main-content {
      display: flex;
      gap: 20px;
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .left-section {
      flex: 7;
    }

    .right-section {
      flex: 3;
      display: flex;
      flex-direction: column;
      max-width: 300px;
      height: calc(100vh - 120px);
      /* å‡å»ä¸Šä¸‹è¾¹è· */
      position: relative;
      /* æ·»åŠ ç›¸å¯¹å®šä½ */
    }

    .header {
      font-size: 36px;
      color: #4a90e2;
      font-weight: bold;
      text-align: center;
      margin-bottom: 20px;
      letter-spacing: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding-left: 0;
    }

    .header input {
      font-family: 'Smiley Sans', sans-serif;
      font-size: 36px;
      color: #4a90e2;
      font-weight: bold;
      text-align: center;
      border: none;
      border-bottom: 2px solid transparent;
      background: transparent;
      width: 120px;
      margin-right: -8px;
      /* ç§»é™¤å³ä¾§é—´è· */
    }

    .header input:focus {
      outline: none;
      border-bottom: 2px solid #4a90e2;
    }

    .screen-banner {
      text-align: center;
      padding: 12px;
      background: #e3f2fd;
      color: #1976d2;
      font-weight: bold;
      margin-bottom: 30px;
      border-radius: 5px;
      font-size: 18px;
      letter-spacing: 1px;
      width: 100%;
      box-sizing: border-box;
      margin-left: 0;
      margin-right: 0;
    }

    .classroom {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      width: 100%;
      box-sizing: border-box;
    }

    .table {
      padding: 15px;
      border-radius: 10px;
    }

    .group-1 {
      background: #fff3b0;
    }

    .group-2 {
      background: #a8d5ff;
    }

    .group-3 {
      background: #ffb74d;
    }

    .group-4 {
      background: #b3e5fc;
    }

    .group-5 {
      background: #c8e6c9;
    }

    .group-6 {
      background: #ffd1dc;
    }

    .table h3 {
      text-align: center;
      margin: 0 0 15px 0;
      color: #2c3e50;
      padding: 10px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 5px;
      font-size: 18px;
      letter-spacing: 1px;
    }

    .seats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .seat {
      background: white;
      padding: 8px;
      border-radius: 5px;
      text-align: center;
    }

    .seat input {
      font-family: 'Smiley Sans', sans-serif;
      width: 100%;
      border: none;
      background: transparent;
      text-align: center;
      padding: 4px;
      white-space: nowrap;
      overflow: visible;
      text-overflow: unset;
      min-width: 0;
    }

    .seat input:focus {
      outline: none;
      background: #f8f9fa;
    }

    .time-display,
    .location-display {
      flex: 1;
      min-width: 300px;
      font-size: 18px;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }

    .time-display {
      background: #fcfde3;
    }

    .location-display {
      background: #f3e5f5;
    }

    .time-display .emoji,
    .location-display .emoji {
      font-size: 32px;
      margin-right: 15px;
      flex-shrink: 0;
      width: 40px;
      text-align: center;
    }

    .info-input {
      border: none;
      border-bottom: 1px solid #ddd;
      padding: 5px;
      margin: 0;
      font-family: 'Smiley Sans', sans-serif;
      font-size: 16px;
      width: 40px;
      text-align: center;
      background: transparent;
    }

    .info-input.wider {
      width: 80px;
    }

    .weekday-select,
    .campus-select {
      font-family: 'Smiley Sans', sans-serif;
      font-size: 16px;
      padding: 5px;
      border: none;
      border-radius: 4px;
      background: white;
      margin: 0;
      min-width: 90px;
    }

    .info-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      width: 100%;
      box-sizing: border-box;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .info-section select {
      background: transparent;
    }

    .notes-section {
      flex: 1;
      background: white;
      padding: 15px;
      border-radius: 10px;
      border: 2px solid #4a90e2;
      display: flex;
      flex-direction: column;
      gap: 10px;
      resize: both;
      /* å…è®¸æ°´å¹³å’Œå‚ç›´æ–¹å‘è°ƒæ•´å¤§å° */
      overflow: auto;
      /* æ·»åŠ æ»šåŠ¨æ¡ */
      min-width: 250px;
      /* æœ€å°å®½åº¦ */
      min-height: 300px;
      /* æœ€å°é«˜åº¦ */
      position: absolute;
      /* ä½¿ç”¨ç»å¯¹å®šä½ */
      top: 76px;
      /* è°ƒæ•´é¡¶éƒ¨ä½ç½®ä¸å·¦ä¾§ info-section å¯¹é½ */
      right: 0;
      left: 0;
      bottom: 20px;
    }

    .notes-section img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 10px auto;
      resize: both;
      overflow: auto;
      border: 1px solid #ddd;
    }

    .notes-toolbar {
      display: flex;
      gap: 10px;
      padding: 5px;
      background: #f8f9fa;
      border-radius: 5px;
      flex-wrap: wrap;
    }

    .notes-toolbar select,
    .notes-toolbar button {
      padding: 4px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      cursor: pointer;
    }

    .notes-content {
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      overflow-y: auto;
      background: white;
      min-height: 100px;
      /* æ·»åŠ æœ€å°é«˜åº¦ */
    }

    .controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
      z-index: 100;
    }

    .controls button {
      font-family: 'Smiley Sans', sans-serif;
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s ease;
    }

    .controls button:hover {
      background: #45a049;
    }

    .edit-mode button {
      background: #2196F3;
    }

    .edit-mode button:hover {
      background: #1976D2;
    }

    /* ç­çº§é€‰æ‹©å™¨æ ·å¼ */
    .class-selector {
      position: fixed;
      left: 20px;
      bottom: 20px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      gap: 10px;
      align-items: center;
      z-index: 100;
      max-width: 260px;
    }

    .class-selector select {
      font-family: 'Smiley Sans', sans-serif;
      padding: 5px 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }

    .class-selector .time-toggle {
      display: flex;
      gap: 5px;
    }

    .class-selector .time-toggle button {
      font-family: 'Smiley Sans', sans-serif;
      padding: 5px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background: #f5f5f5;
      color: #666;
    }

    .class-selector .time-toggle button.active {
      background: #4a90e2;
      color: white;
    }

    .class-selector .delete-btn {
      padding: 5px 10px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    /* ä¿å­˜é…ç½®å¯¹è¯æ¡†æ ·å¼ */
    .save-dialog {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      width: 300px;
    }

    .save-dialog input {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: 'Smiley Sans', sans-serif;
    }

    .save-dialog .buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
    }

    /* å¯¼å…¥å¯¹è¯æ¡†æ ·å¼ */
    .import-dialog {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      width: 80%;
      max-width: 500px;
    }

    .import-dialog h2 {
      margin-top: 0;
      color: #4a90e2;
    }

    /* æ·»åŠ å¸ƒå±€é€‰æ‹©å™¨æ ·å¼ */
    .layout-selector {
      margin: 15px 0;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 5px;
    }

    .layout-selector label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
    }

    .layout-selector input[type="radio"] {
      margin-right: 8px;
    }

    .layout-option {
      display: inline-block;
      margin-right: 20px;
      padding: 8px;
      cursor: pointer;
    }

    .layout-option:hover {
      background: #e0e0e0;
      border-radius: 5px;
    }

    /* ä¸‰æ¨ªæ’è¡¨æ ¼å¼å¸ƒå±€ */
    .three-rows-layout {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
    }

    .row-table-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: white;
      border-radius: 10px;
    }

    .row-label {
      writing-mode: vertical-lr;
      text-align: center;
      font-size: 15px;
      font-weight: bold;
      color: #2c3e50;
      padding: 8px 5px;
      background: #e8e8e8;
      border-radius: 6px;
      letter-spacing: 4px;
      flex-shrink: 0;
    }

    .row-table {
      border-collapse: collapse;
      /* table ä¸æ‹‰ä¼¸ï¼Œç”±å†…å®¹å†³å®šå®½åº¦ */
      width: auto;
    }

    .row-table th {
      font-size: 13px;
      font-weight: normal;
      color: #888;
      padding: 5px 8px;
      text-align: center;
      min-width: 70px;
    }

    .row-table td {
      padding: 4px 4px;
      text-align: center;
      min-width: 70px;
    }

    .row-table td input {
      width: 100%;
      border: none;
      background: white;
      text-align: center;
      padding: 8px 4px;
      border-radius: 5px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .row-table td input:focus {
      outline: none;
      background: #f0f0f0;
    }

    /* å·¦å³åˆ†ç»„ä¹‹é—´çš„é—´éš”åˆ— */
    .row-table .gap-col {
      min-width: 16px;
      width: 16px;
      background: transparent !important;
      padding: 0;
    }

    .import-dialog textarea {
      width: 100%;
      height: 200px;
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: 'Smiley Sans', sans-serif;
      resize: vertical;
    }

    .import-dialog .buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .import-dialog button {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Smiley Sans', sans-serif;
    }

    .import-dialog .confirm {
      background: #4CAF50;
      color: white;
    }

    .import-dialog .cancel {
      background: #f5f5f5;
      color: #333;
    }

    .error {
      color: #f44336;
      margin-top: 10px;
    }

    .success {
      color: #4CAF50;
      margin-top: 10px;
    }

    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    .notes-toolbar .text-align-group {
      display: flex;
      gap: 5px;
    }

    .notes-toolbar .text-align-group button {
      padding: 4px 8px;
      background: white;
      border: 1px solid #ddd;
      cursor: pointer;
    }

    .notes-toolbar .text-align-group button.active {
      background: #4a90e2;
      color: white;
    }

    .save-button {
      position: fixed;
      bottom: 90px;
      right: 20px;
      font-family: 'Smiley Sans', sans-serif;
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s ease;
      z-index: 200;
    }

    .save-button:hover {
      background: #45a049;
    }

    /* æ‰¹é‡å¯¼å…¥å¯¹è¯æ¡†æ ·å¼ */
    .batch-import-dialog {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .batch-import-dialog h2 {
      margin-top: 0;
      color: #4a90e2;
      margin-bottom: 20px;
    }

    .batch-import-dialog .format-example {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
      font-family: monospace;
      white-space: pre-wrap;
      font-size: 14px;
    }

    .batch-import-dialog textarea {
      width: 100%;
      height: 300px;
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: monospace;
      resize: vertical;
    }

    /* æ–°å¢çš„åœ†å¼§å¸ƒå±€æ ·å¼ */
    .arc-layout {
      .arc-seats {
        display: flex;
        justify-content: center;
        align-items: flex-end;
        flex-wrap: nowrap;
        width: 100%;
        gap: 4px;
        padding: 10px 0;
      }

      .arc-seat {
        width: 50px;
        height: 35px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .arc-seat input {
        font-family: 'Smiley Sans', sans-serif;
        width: 100%;
        height: 100%;
        border: none;
        background: transparent;
        text-align: center;
        padding: 2px;
        font-size: 12px;
        outline: none;
      }

      display: flex;
      flex-direction: column;
      gap: 24px;
      width: 100%;
    }

    .arc-row {
      min-height: 120px;
      padding: 20px;
      margin-bottom: 20px;
      background: white;
      padding: 15px 20px 20px 20px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 140px;
      overflow: visible;
    }
  </style>
</head>

<body>
  <div class="overlay" id="overlay"></div>
  <div class="class-selector isShow">
    <select id="classSelect" onchange="loadClass()">
      <option value="">é€‰æ‹©ç­çº§...</option>
    </select>
    <div class="time-toggle">
      <button onclick="toggleTime('weekday')" id="weekdayBtn" class="active">å‘¨ä¸­</button>
      <button onclick="toggleTime('weekend')" id="weekendBtn">å‘¨æœ«</button>
    </div>
    <button class="delete-btn" onclick="deleteCurrentClass()">åˆ é™¤</button>
  </div>

  <div class="save-dialog" id="saveDialog">
    <h2>ä¿å­˜ç­çº§é…ç½®</h2>
    <input type="text" id="saveClassName" placeholder="è¾“å…¥ç­çº§åç§°">
    <div class="buttons">
      <button class="cancel" onclick="hideSaveDialog()">å–æ¶ˆ</button>
      <button class="confirm" onclick="saveClass()">ä¿å­˜</button>
    </div>
  </div>
  <div class="import-dialog" id="importDialog">
    <h2>å¯¼å…¥å­¦ç”Ÿåå•</h2>
    <div class="layout-selector">
      <label>é€‰æ‹©æ•™å®¤å¸ƒå±€ï¼š</label>
      <div class="layout-option">
        <input type="radio" name="layout" value="circular" id="circularLayout" checked>
        <label for="circularLayout">å…­å¼ åœ†æ¡Œå¸ƒå±€</label>
      </div>
      <div class="layout-option">
        <input type="radio" name="layout" value="rows" id="rowsLayout">
        <label for="rowsLayout">ä¸‰æ¨ªæ’å¸ƒå±€</label>
      </div>
      <div class="layout-option">
        <input type="radio" name="layout" value="arc" id="arcLayout">
        <label for="arcLayout">åœ†å¼§å¸ƒå±€</label>
      </div>
    </div>
    <p>è¯·è¾“å…¥å­¦ç”Ÿåå•ï¼ˆæ¯è¡Œä¸€ä¸ªåå­—ï¼‰ï¼š</p>
    <div id="layoutDescription">
      <ul style="font-size: 14px; color: #666; margin: 10px 0;">
        <li>31-36äººï¼š6ä¸ªå°ç»„</li>
        <li>25-30äººï¼š5ä¸ªå°ç»„</li>
        <li>19-24äººï¼š4ä¸ªå°ç»„ï¼ˆç¬¬1ã€2ã€3ã€5ç»„ï¼‰</li>
        <li>1-18äººï¼š3ä¸ªå°ç»„ï¼ˆç¬¬1ã€2ã€3ç»„ï¼‰</li>
      </ul>
    </div>
    <textarea id="studentNames" placeholder="è¯·è¾“å…¥å­¦ç”Ÿåå­—ï¼Œæ¯è¡Œä¸€ä¸ª..."></textarea>
    <div id="errorMsg"></div>
    <div class="buttons">
      <button class="cancel" onclick="hideImportDialog()">å–æ¶ˆ</button>
      <button class="confirm" onclick="importStudents()">ç¡®è®¤å¯¼å…¥</button>
    </div>
  </div>
  <div class="batch-import-dialog" id="batchImportDialog">
    <h2>æ‰¹é‡å¯¼å…¥ç­çº§é…ç½®</h2>
    <p>è¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å…¥æ•°æ®ï¼ˆä½¿ç”¨!ä½œä¸ºç­çº§åˆ†éš”ç¬¦ï¼‰ï¼š</p>
    <div class="format-example">ç­çº§åç§°: J328
      æ ¡åŒº: C86æ ¡åŒº
      æ¥¼å±‚: 1
      æ•™å®¤: 101

      å‘¨ä¸­å¸ƒå±€: åœ†æ¡Œ
      å‘¨ä¸­æ—¶é—´:
      æœˆ: 9
      æ—¥: 1
      æ˜ŸæœŸ: æ˜ŸæœŸä¸€
      æ—¶é—´: 14:30

      Group 1: Jenny, Andy, Rain, Anthony, Mila, Annaç‹
      Group 2: Bella, Sunny, Davidä¸Šå®˜, Amy, Annaå´, Rambo
      Group 3: Leo, Nini, Davidèµ„æ–‡, Jasper, Bonnie, Emily
      Group 4: Thea, Melody, Shaun, Hardy, Perry
      Group 5: Aurora, Wayne, Sam, Candy, Poseidon, Tammy
      Group 6: Ivy, Spring, Alina, Jun, Scarlett

      å‘¨æœ«å¸ƒå±€: ä¸‰æ’
      å‘¨æœ«æ—¶é—´:
      æœˆ: 9
      æ—¥: 2
      æ˜ŸæœŸ: æ˜ŸæœŸå…­
      æ—¶é—´: 10:30

      Group 1: Jenny, Andy, Rain, Anthony, Mila, Annaç‹
      Group 2: Bella, Sunny, Davidä¸Šå®˜, Amy, Annaå´, Rambo
      Group 3: Leo, Nini, Davidèµ„æ–‡, Jasper, Bonnie, Emily
      Group 4: Thea, Melody, Shaun, Hardy, Perry
      Group 5: Aurora, Wayne, Sam, Candy, Poseidon, Tammy
      Group 6: Ivy, Spring, Alina, Jun, Scarlett

      !

      ç­çº§åç§°: J329
      æ ¡åŒº: ä¸ƒå½©æ ¡åŒº
      æ¥¼å±‚: 2
      æ•™å®¤: 202

      å‘¨ä¸­å¸ƒå±€: ä¸‰æ’
      å‘¨ä¸­æ—¶é—´:
      æœˆ: 9
      æ—¥: 1
      æ˜ŸæœŸ: æ˜ŸæœŸä¸€
      æ—¶é—´: 14:30

      Group 1: Jenny, Andy, Rain, Anthony, Mila, Annaç‹
      Group 2: Bella, Sunny, Davidä¸Šå®˜, Amy, Annaå´, Rambo
      Group 3: Leo, Nini, Davidèµ„æ–‡, Jasper, Bonnie, Emily
      Group 4: Thea, Melody, Shaun, Hardy, Perry
      Group 5: Aurora, Wayne, Sam, Candy, Poseidon, Tammy
      Group 6: Ivy, Spring, Alina, Jun, Scarlett

      å‘¨æœ«å¸ƒå±€: åœ†æ¡Œ
      å‘¨æœ«æ—¶é—´:
      æœˆ: 9
      æ—¥: 2
      æ˜ŸæœŸ: æ˜ŸæœŸå…­
      æ—¶é—´: 10:30

      Group 1: Jenny, Andy, Rain, Anthony, Mila, Annaç‹
      Group 2: Bella, Sunny, Davidä¸Šå®˜, Amy, Annaå´, Rambo
      Group 3: Leo, Nini, Davidèµ„æ–‡, Jasper, Bonnie, Emily
      Group 4: Thea, Melody, Shaun, Hardy, Perry
      Group 5: Aurora, Wayne, Sam, Candy, Poseidon, Tammy
      Group 6: Ivy, Spring, Alina, Jun, Scarlett</div>
    <textarea id="batchImportData" placeholder="åœ¨æ­¤è¾“å…¥æ•°æ®..."></textarea>
    <div id="batchImportError" class="error"></div>
    <div class="buttons">
      <button class="cancel" onclick="hideBatchImportDialog()">å–æ¶ˆ</button>
      <button class="confirm" onclick="processBatchImport()">ç¡®è®¤å¯¼å…¥</button>
    </div>
  </div>
  <div class="main-content">
    <div class="left-section">
      <div class="header">
        <input type="text" id="headerClassName" value="J328" placeholder="XXXX" maxlength="4">ç­åº§ä½è¡¨
      </div>
      <div class="info-section">
        <div class="time-display">
          <span class="emoji">â°</span>
          <input type="text" class="info-input" id="date" placeholder="æœˆ">æœˆ
          <input type="text" class="info-input" id="day" placeholder="æ—¥">æ—¥
          <select class="weekday-select" id="weekday">
            <option value="">é€‰æ‹©æ˜ŸæœŸ</option>
            <option value="æ˜ŸæœŸä¸€">æ˜ŸæœŸä¸€</option>
            <option value="æ˜ŸæœŸäºŒ">æ˜ŸæœŸäºŒ</option>
            <option value="æ˜ŸæœŸä¸‰">æ˜ŸæœŸä¸‰</option>
            <option value="æ˜ŸæœŸå››">æ˜ŸæœŸå››</option>
            <option value="æ˜ŸæœŸäº”">æ˜ŸæœŸäº”</option>
            <option value="æ˜ŸæœŸå…­">æ˜ŸæœŸå…­</option>
            <option value="æ˜ŸæœŸæ—¥">æ˜ŸæœŸæ—¥</option>
          </select>
          <input type="text" class="info-input wider" id="time" placeholder="æ—¶é—´">
        </div>
        <div class="location-display">
          <span class="emoji">ğŸ«</span>
          <select class="campus-select" id="campus">
            <option value="">é€‰æ‹©æ ¡åŒº</option>
            <option value="C86æ ¡åŒº">C86æ ¡åŒº</option>
            <option value="ä¸ƒå½©æ ¡åŒº">ä¸ƒå½©æ ¡åŒº</option>
          </select>
          <input type="text" class="info-input" id="floor" placeholder="æ¥¼">æ¥¼
          <input type="text" class="info-input wider" id="room" placeholder="æ•™å®¤">
        </div>
      </div>
      <div class="screen-banner">å±å¹• & ç™½æ¿</div>
      <div class="classroom" id="classroom"></div>
    </div>
    <div class="right-section">
      <div class="notes-section">
        <div class="notes-toolbar isShow">
          <select id="noteFontSize">
            <option value="12">12px</option>
            <option value="14">14px</option>
            <option value="16" selected>16px</option>
            <option value="18">18px</option>
            <option value="20">20px</option>
            <option value="24">24px</option>
          </select>
          <input type="color" id="noteColor" value="#000000">
          <div class="text-align-group">
            <button onclick="setTextAlign('left')" title="å·¦å¯¹é½"><i>â¬…ï¸</i></button>
            <button onclick="setTextAlign('center')" title="å±…ä¸­å¯¹é½"><i>â¬†ï¸</i></button>
            <button onclick="setTextAlign('right')" title="å³å¯¹é½"><i>â¡ï¸</i></button>
          </div>
          <div class="text-align-group">
            <button onclick="setVerticalAlign('top')" title="é¡¶éƒ¨å¯¹é½"><i>â¬†ï¸</i></button>
            <button onclick="setVerticalAlign('middle')" title="å‚ç›´å±…ä¸­"><i>â†•ï¸</i></button>
            <button onclick="setVerticalAlign('bottom')" title="åº•éƒ¨å¯¹é½"><i>â¬‡ï¸</i></button>
          </div>
        </div>
        <div class="notes-content" id="notes" contenteditable="true" placeholder="åœ¨æ­¤æ·»åŠ å¤‡æ³¨å†…å®¹..."></div>
      </div>
    </div>
  </div>
  <button class="save-button isShow" onclick="showSaveDialog()">ä¿å­˜é…ç½®</button>
  <div class="controls isShow">
    <button onclick="showBatchImportDialog()">æ‰¹é‡å¯¼å…¥</button>
    <button onclick="showImportDialog()">å¯¼å…¥åå•</button>
    <div class="edit-mode">
      <button onclick="toggleEditMode()">ç¼–è¾‘æ¨¡å¼</button>
    </div>
    <button onclick="toggleLayout()">åˆ‡æ¢å¸ƒå±€</button>
    <button onclick="generateSeating()">ä¸‹ä¸€æ¬¡è½®æ¢</button>
    <button onclick="">æŒ‰F2æ¸…é™¤UI</button>
  </div>
  <script>
    document.addEventListener('keydown', function (event) {
      var isShowStyle = document.querySelector('.isShow');

      if (event.key === 'F2' || event.keyCode === 131) {
        if (isShowStyle.style.display == 'none') {
          document.querySelectorAll('.isShow').forEach(element => {
            element.style.display = '';
          });
        } else {
          document.querySelectorAll('.isShow').forEach(element => {
            element.style.display = 'none';
          });
        }
      }
    });
    let isEditMode = false;
    let currentArrangement = 0;
    let currentTimeMode = 'weekday';
    let currentLayout = 'circular'; // æ–°å¢ï¼šå½“å‰å¸ƒå±€ç±»å‹
    let groups = Array(6).fill().map(() => Array(6).fill('')); // åœ†æ¡Œå¸ƒå±€çš„ç»„
    let rowGroups = { // æ–°å¢ï¼šä¸‰æ¨ªæ’å¸ƒå±€çš„ç»„
      rows: Array(3).fill().map(() => ({
        left: Array(7).fill(''),
        right: Array(7).fill('')
      })),
      // colorOrder[i] è¡¨ç¤ºç¬¬ i ä¸ªå°ç»„ä½ç½®(0=ç¬¬ä¸€æ’å·¦,1=ç¬¬ä¸€æ’å³,2=ç¬¬äºŒæ’å·¦,...) å¯¹åº”çš„é¢œè‰²ç¼–å·(1~6)
      colorOrder: [1, 2, 3, 4, 5, 6]
    };
    let arcGroups = { // æ–°å¢ï¼šåœ†å¼§å¸ƒå±€ï¼Œä¸¤æ’ï¼Œæ¯æ’18ä¸ª
      rows: [Array(18).fill(''), Array(18).fill('')]
    };

    // è·å–æœ‰å­¦ç”Ÿçš„ç»„çš„ç´¢å¼•åˆ—è¡¨
    function getActiveGroupIndices() {
      const indices = [];
      for (let i = 0; i < 6; i++) {
        if (groups[i].some(name => name !== '')) {
          indices.push(i);
        }
      }
      return indices.length > 0 ? indices : [0]; // è‡³å°‘è¿”å›ä¸€ä¸ª
    }

    // æ ¹æ®å½“å‰è½®æ¢æ¬¡æ•°ï¼Œè·å–æ¯ä¸ªç‰©ç†ä½ç½®åº”è¯¥æ˜¾ç¤ºå“ªä¸ªç»„
    // è¿”å›é•¿åº¦ä¸º6çš„æ•°ç»„ï¼Œmapping[ç‰©ç†ä½ç½®] = ç»„ç´¢å¼•
    function getRotationMapping() {
      const activeIndices = getActiveGroupIndices();
      const n = activeIndices.length;
      const shift = currentArrangement % n;

      // æ„å»ºç‰©ç†ä½ç½®åˆ°ç»„çš„æ˜ å°„ï¼ˆ6ä¸ªä½ç½®ï¼‰
      const mapping = Array(6).fill(-1);

      // æ´»è·ƒç»„åœ¨å›ºå®šçš„ç‰©ç†ä½ç½®ä¹‹é—´è½®æ¢
      // ä¾‹å¦‚4ç»„æ—¶ï¼šç‰©ç†ä½ç½® [0,1,2,4]ï¼Œç»„æ•°æ® [0,1,2,4]
      // shift=1æ—¶ï¼šä½ç½®0æ”¾ç»„4ï¼Œä½ç½®1æ”¾ç»„0ï¼Œä½ç½®2æ”¾ç»„1ï¼Œä½ç½®4æ”¾ç»„2
      for (let i = 0; i < n; i++) {
        const physicalPos = activeIndices[i];
        const groupIdx = activeIndices[(i - shift + n) % n];
        mapping[physicalPos] = groupIdx;
      }

      // éæ´»è·ƒä½ç½®æ˜¾ç¤ºå¯¹åº”çš„ç©ºç»„æ•°æ®
      for (let pos = 0; pos < 6; pos++) {
        if (mapping[pos] === -1) {
          mapping[pos] = pos;
        }
      }

      return mapping;
    }

    // ä¿å­˜æ‰€æœ‰ç­çº§çš„æ•°æ®
    let classData = {};

    // è·å–æ—¶é—´å’Œåœ°ç‚¹ä¿¡æ¯
    function getLocationInfo() {
      return {
        date: document.getElementById('date').value,
        day: document.getElementById('day').value,
        weekday: document.getElementById('weekday').value,
        time: document.getElementById('time').value,
        campus: document.getElementById('campus').value,
        floor: document.getElementById('floor').value,
        room: document.getElementById('room').value,
        notes: document.getElementById('notes').innerHTML
      };
    }

    // è®¾ç½®æ—¶é—´å’Œåœ°ç‚¹ä¿¡æ¯
    function setLocationInfo(info) {
      if (!info) return;
      document.getElementById('date').value = info.date || '';
      document.getElementById('day').value = info.day || '';
      document.getElementById('weekday').value = info.weekday || '';
      document.getElementById('time').value = info.time || '';
      document.getElementById('campus').value = info.campus || '';
      document.getElementById('floor').value = info.floor || '';
      document.getElementById('room').value = info.room || '';
      document.getElementById('notes').innerHTML = info.notes || '';
    }

    // ä»localStorageåŠ è½½æ•°æ®
    function loadSavedData() {
      const saved = localStorage.getItem('classSeatingData');
      if (saved) {
        classData = JSON.parse(saved);
        updateClassSelect();
      }
    }

    // æ›´æ–°ç­çº§é€‰æ‹©ä¸‹æ‹‰æ¡†
    function updateClassSelect() {
      const select = document.getElementById('classSelect');
      select.innerHTML = '<option value="">é€‰æ‹©ç­çº§...</option>';
      Object.keys(classData).forEach(className => {
        const option = document.createElement('option');
        option.value = className;
        option.textContent = className;
        select.appendChild(option);
      });
    }

    // åˆ‡æ¢æ—¶é—´æ¨¡å¼ï¼ˆå‘¨ä¸­/å‘¨æœ«ï¼‰
    function toggleTime(mode) {
      currentTimeMode = mode;
      document.getElementById('weekdayBtn').className = mode === 'weekday' ? 'active' : '';
      document.getElementById('weekendBtn').className = mode === 'weekend' ? 'active' : '';
      loadClass();
    }

    // æ˜¾ç¤ºä¿å­˜å¯¹è¯æ¡†
    function showSaveDialog() {
      const headerClassName = document.getElementById('headerClassName').value;
      document.getElementById('saveClassName').value = headerClassName;
      document.getElementById('saveDialog').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
    }

    // éšè—ä¿å­˜å¯¹è¯æ¡†
    function hideSaveDialog() {
      document.getElementById('saveDialog').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    }

    // ä¿å­˜å½“å‰é…ç½®
    function saveClass() {
      const className = document.getElementById('saveClassName').value.trim();
      if (!className) {
        alert('è¯·è¾“å…¥ç­çº§åç§°');
        return;
      }

      // ä¿å­˜å½“å‰é…ç½®
      if (!classData[className]) {
        classData[className] = {
          weekday: {
            layout: currentLayout,
            groups: null,
            rowGroups: null,
            currentArrangement: 0,
            locationInfo: {}
          },
          weekend: {
            layout: currentLayout,
            groups: null,
            rowGroups: null,
            currentArrangement: 0,
            locationInfo: {}
          }
        };
      }

      classData[className][currentTimeMode] = {
        layout: currentLayout,
        groups: currentLayout === 'circular' ? JSON.parse(JSON.stringify(groups)) : null,
        rowGroups: currentLayout === 'rows' ? JSON.parse(JSON.stringify(rowGroups)) : null,
        arcGroups: currentLayout === 'arc' ? JSON.parse(JSON.stringify(arcGroups)) : null,
        currentArrangement: currentArrangement,
        locationInfo: getLocationInfo()
      };

      // ä¿å­˜åˆ°localStorage
      localStorage.setItem('classSeatingData', JSON.stringify(classData));

      // æ›´æ–°é€‰æ‹©æ¡†å’Œæ ‡é¢˜
      updateClassSelect();
      document.getElementById('classSelect').value = className;
      document.getElementById('headerClassName').value = className;

      hideSaveDialog();
    }

    // åŠ è½½é€‰ä¸­çš„ç­çº§
    function loadClass() {
      const className = document.getElementById('classSelect').value;
      if (className && classData[className] && classData[className][currentTimeMode]) {
        const data = classData[className][currentTimeMode];

        // å…ˆè®¾ç½®å¸ƒå±€ç±»å‹
        currentLayout = data.layout || 'circular';

        // æ ¹æ®å¸ƒå±€ç±»å‹åˆå§‹åŒ–æ•°æ®ç»“æ„
        if (currentLayout === 'circular') {
          groups = JSON.parse(JSON.stringify(data.groups || Array(6).fill().map(() => Array(6).fill(''))));
          // é‡ç½®å…¶ä»–å¸ƒå±€æ•°æ®
          rowGroups = {
            rows: Array(3).fill().map(() => ({
              left: Array(7).fill(''),
              right: Array(7).fill('')
            })),
            colorOrder: [1, 2, 3, 4, 5, 6]
          };
          arcGroups = {
            rows: [Array(18).fill(''), Array(18).fill('')]
          };
        } else if (currentLayout === 'rows') {
          rowGroups = JSON.parse(JSON.stringify(data.rowGroups || {
            rows: Array(3).fill().map(() => ({
              left: Array(7).fill(''),
              right: Array(7).fill('')
            }))
          }));
          // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœæ²¡æœ‰ colorOrderï¼Œè¡¥ä¸Šé»˜è®¤å€¼
          if (!rowGroups.colorOrder) rowGroups.colorOrder = [1, 2, 3, 4, 5, 6];
          // é‡ç½®å…¶ä»–å¸ƒå±€æ•°æ®
          groups = Array(6).fill().map(() => Array(6).fill(''));
          arcGroups = {
            rows: [Array(18).fill(''), Array(18).fill('')]
          };
        } else if (currentLayout === 'arc') {
          arcGroups = JSON.parse(JSON.stringify(data.arcGroups || {
            rows: [Array(18).fill(''), Array(18).fill('')]
          }));
          // é‡ç½®å…¶ä»–å¸ƒå±€æ•°æ®
          groups = Array(6).fill().map(() => Array(6).fill(''));
          rowGroups = {
            rows: Array(3).fill().map(() => ({
              left: Array(7).fill(''),
              right: Array(7).fill('')
            })),
            colorOrder: [1, 2, 3, 4, 5, 6]
          };
        }

        currentArrangement = data.currentArrangement || 0;
        setLocationInfo(data.locationInfo || {});
        document.getElementById('headerClassName').value = className;

        // é‡ç½®æ•™å®¤å®¹å™¨çš„æ ·å¼
        const classroom = document.getElementById('classroom');
        classroom.className = 'classroom';
        if (currentLayout === 'rows') {
          classroom.classList.add('three-rows-layout');
        } else if (currentLayout === 'arc') {
          classroom.classList.add('arc-layout');
        }

        // åˆ·æ–°åº§ä½æ˜¾ç¤º
        refreshSeating();
      } else {
        // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œé‡ç½®ä¸ºé»˜è®¤çŠ¶æ€
        currentLayout = 'circular';
        groups = Array(6).fill().map(() => Array(6).fill(''));
        rowGroups = {
          rows: Array(3).fill().map(() => ({
            left: Array(7).fill(''),
            right: Array(7).fill('')
          })),
          colorOrder: [1, 2, 3, 4, 5, 6]
        };
        arcGroups = {
          rows: [Array(18).fill(''), Array(18).fill('')]
        };
        currentArrangement = 0;
        setLocationInfo({});
        document.getElementById('headerClassName').value = className || '';

        // é‡ç½®æ•™å®¤å®¹å™¨çš„æ ·å¼
        const classroom = document.getElementById('classroom');
        classroom.className = 'classroom';

        refreshSeating();
      }
    }

    // åˆ é™¤å½“å‰ç­çº§
    function deleteCurrentClass() {
      const className = document.getElementById('classSelect').value;
      if (className && confirm(`ç¡®å®šè¦åˆ é™¤ ${className} çš„æ‰€æœ‰é…ç½®å—ï¼Ÿ`)) {
        delete classData[className];
        localStorage.setItem('classSeatingData', JSON.stringify(classData));
        updateClassSelect();
        document.getElementById('headerClassName').value = '';
        groups = Array(6).fill().map(() => Array(6).fill(''));
        currentArrangement = 0;
        setLocationInfo({});
        refreshSeating();
      }
    }

    // æ·»åŠ ç¼ºå¤±çš„å‡½æ•°
    function showImportDialog() {
      document.getElementById('importDialog').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
      document.getElementById('errorMsg').textContent = '';
      document.getElementById('errorMsg').className = '';
      document.getElementById('studentNames').value = '';
    }

    function hideImportDialog() {
      document.getElementById('importDialog').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    }

    function importStudents() {
      const input = document.getElementById('studentNames').value;
      const newNames = input.split('\n')
        .map(name => name.trim())
        .filter(name => name.length > 0);
      const totalStudents = newNames.length;
      const isCircular = document.getElementById('circularLayout').checked;
      const isRows = document.getElementById('rowsLayout').checked;
      const isArc = document.getElementById('arcLayout').checked;

      if (isCircular) {
        importCircularLayout(newNames, totalStudents);
      } else if (isRows) {
        importRowLayout(newNames, totalStudents);
      } else if (isArc) {
        importArcLayout(input);
      }
    }

    // æ ¹æ®æ€»äººæ•°è®¡ç®—éœ€è¦å¤šå°‘ç»„
    function calcNumGroups(totalStudents) {
      if (totalStudents >= 31) return 6;
      if (totalStudents >= 25) return 5;
      if (totalStudents >= 19) return 4;
      return 3; // 0-18äººç”¨3ç»„
    }

    // è·å–æŒ‡å®šç»„æ•°ä¸‹å®é™…ä½¿ç”¨çš„ç»„ç´¢å¼•
    // 4ç»„æ—¶ç”¨ [0,1,2,4]ï¼ˆç¬¬1,2,3,5ç»„ï¼‰ï¼Œå…¶ä»–æŒ‰é¡ºåº
    function getGroupIndicesForCount(numGroups) {
      if (numGroups === 4) return [0, 1, 2, 4];
      const indices = [];
      for (let i = 0; i < numGroups; i++) indices.push(i);
      return indices;
    }

    function importCircularLayout(newNames, totalStudents) {
      if (totalStudents > 36) {
        showError(`å­¦ç”Ÿäººæ•°ä¸èƒ½è¶…è¿‡36äººï¼Œå½“å‰è¾“å…¥äº†${totalStudents}ä¸ªåå­—`);
        return;
      }

      if (totalStudents === 0) {
        showError('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªå­¦ç”Ÿåå­—');
        return;
      }

      const numGroups = calcNumGroups(totalStudents);
      const groupIndices = getGroupIndicesForCount(numGroups);
      const baseStudentsPerGroup = Math.floor(totalStudents / numGroups);
      const extraStudents = totalStudents % numGroups;

      groups = Array(6).fill().map(() => Array(6).fill(''));
      let currentStudent = 0;

      for (let i = 0; i < numGroups; i++) {
        const groupIdx = groupIndices[i];
        const studentsInThisGroup = i < extraStudents ?
          baseStudentsPerGroup + 1 :
          baseStudentsPerGroup;

        for (let j = 0; j < studentsInThisGroup; j++) {
          if (currentStudent < newNames.length) {
            groups[groupIdx][j] = newNames[currentStudent];
            currentStudent++;
          }
        }
      }

      currentLayout = 'circular';
      currentArrangement = 0;
      saveAndRefresh(`æˆåŠŸå¯¼å…¥${totalStudents}åå­¦ç”Ÿï¼Œå·²å‡è¡¡åˆ†é…åˆ°${numGroups}ä¸ªå°ç»„`);
    }

    function importRowLayout(newNames, totalStudents) {
      if (totalStudents === 0) {
        showError('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªå­¦ç”Ÿåå­—');
        return;
      }

      if (totalStudents > 42) {
        showError(`ä¸‰æ¨ªæ’å¸ƒå±€æœ€å¤šæ”¯æŒ42äººï¼ˆæ¯æ’14äººï¼‰ï¼Œå½“å‰è¾“å…¥äº†${totalStudents}ä¸ªåå­—`);
        return;
      }

      // è®¡ç®—æ¯æ’äººæ•°
      const studentsPerRow = Math.ceil(totalStudents / 3);
      let remainingStudents = totalStudents;

      rowGroups.rows = Array(3).fill().map(() => ({
        left: Array(7).fill(''),
        right: Array(7).fill('')
      }));
      rowGroups.colorOrder = [1, 2, 3, 4, 5, 6];

      let currentStudent = 0;

      // ä¸ºæ¯ä¸€æ’åˆ†é…å­¦ç”Ÿ
      for (let row = 0; row < 3; row++) {
        const thisRowStudents = Math.min(studentsPerRow, remainingStudents);
        const leftGroupSize = Math.ceil(thisRowStudents / 2);
        const rightGroupSize = thisRowStudents - leftGroupSize;

        // åˆ†é…å·¦è¾¹å°ç»„
        for (let i = 0; i < leftGroupSize && currentStudent < newNames.length; i++) {
          rowGroups.rows[row].left[i] = newNames[currentStudent++];
        }

        // åˆ†é…å³è¾¹å°ç»„
        for (let i = 0; i < rightGroupSize && currentStudent < newNames.length; i++) {
          rowGroups.rows[row].right[i] = newNames[currentStudent++];
        }

        remainingStudents -= thisRowStudents;
      }

      currentLayout = 'rows';
      currentArrangement = 0;
      saveAndRefresh(`æˆåŠŸå¯¼å…¥${totalStudents}åå­¦ç”Ÿï¼Œå·²å‡è¡¡åˆ†é…åˆ°ä¸‰æ’`);
    }

    function importArcLayout(rawInput) {
      // æ”¯æŒä»¥ä¸‹æ ¼å¼ï¼š
      // 1) ç¬¬ä¸€æ’: a,b,c\nç¬¬äºŒæ’: d,e,fï¼ˆæ”¯æŒä¸­æ–‡é€—å·ï¼‰
      // 2) ä¸¤è¡Œæ— æ ‡ç­¾ï¼šç¬¬ä¸€è¡Œ=ç¬¬ä¸€æ’ï¼Œç¬¬äºŒè¡Œ=ç¬¬äºŒæ’
      const lines = rawInput.split('\n').map(l => l.trim()).filter(l => l);
      let first = [];
      let second = [];

      const splitNames = (text) => text
        .split(/[,ï¼Œ]/)
        .map(s => s.trim())
        .filter(Boolean);

      const firstLine = lines[0] || '';
      const secondLine = lines[1] || '';

      if (firstLine.startsWith('ç¬¬ä¸€æ’')) {
        const part = firstLine.substring(firstLine.indexOf(':') + 1);
        first = splitNames(part);
      } else if (firstLine) {
        first = splitNames(firstLine);
      }

      if (secondLine.startsWith('ç¬¬äºŒæ’')) {
        const part = secondLine.substring(secondLine.indexOf(':') + 1);
        second = splitNames(part);
      } else if (secondLine) {
        second = splitNames(secondLine);
      }

      const total = first.length + second.length;
      if (total > 36) {
        showError(`åœ†å¼§å¸ƒå±€æœ€å¤šæ”¯æŒ36äººï¼ˆæ¯æ’æœ€å¤š18äººï¼‰ï¼Œå½“å‰è¾“å…¥äº†${total}äºº`);
        return;
      }

      arcGroups.rows = [Array(18).fill(''), Array(18).fill('')];
      placeCentered(arcGroups.rows[0], first);
      placeCentered(arcGroups.rows[1], second);

      currentLayout = 'arc';
      currentArrangement = 0;
      saveAndRefresh(`æˆåŠŸå¯¼å…¥åœ†å¼§å¸ƒå±€ï¼Œå…±${total}äºº`);
    }

    function placeCentered(targetArray, names) {
      // å±…ä¸­æ‘†æ”¾ï¼šä»ä¸­é—´ç´¢å¼•å¼€å§‹ï¼Œå·¦å³äº¤æ›¿æ‰©å±•
      const width = targetArray.length; // 18
      let centerLeft = Math.floor((width - 1) / 2); // 8
      let centerRight = centerLeft + 1; // 9
      let useLeft = true;
      let idx = 0;
      while (idx < names.length && (centerLeft >= 0 || centerRight < width)) {
        if (useLeft && centerLeft >= 0) {
          targetArray[centerLeft--] = names[idx++];
        } else if (!useLeft && centerRight < width) {
          targetArray[centerRight++] = names[idx++];
        }
        useLeft = !useLeft;
      }
    }

    function showError(message) {
      document.getElementById('errorMsg').textContent = message;
      document.getElementById('errorMsg').className = 'error';
    }

    function saveAndRefresh(message) {
      hideImportDialog();
      refreshSeating();

      const className = document.getElementById('classSelect').value;
      if (className) {
        if (!classData[className]) {
          classData[className] = {
            weekday: {
              layout: currentLayout,
              groups: null,
              rowGroups: null,
              currentArrangement: 0,
              locationInfo: {}
            },
            weekend: {
              layout: currentLayout,
              groups: null,
              rowGroups: null,
              currentArrangement: 0,
              locationInfo: {}
            }
          };
        }

        classData[className][currentTimeMode] = {
          layout: currentLayout,
          groups: currentLayout === 'circular' ? JSON.parse(JSON.stringify(groups)) : null,
          rowGroups: currentLayout === 'rows' ? JSON.parse(JSON.stringify(rowGroups)) : null,
          arcGroups: currentLayout === 'arc' ? JSON.parse(JSON.stringify(arcGroups)) : null,
          currentArrangement: currentArrangement,
          locationInfo: getLocationInfo()
        };

        localStorage.setItem('classSeatingData', JSON.stringify(classData));
      }

      document.getElementById('errorMsg').textContent = message;
      document.getElementById('errorMsg').className = 'success';
      setTimeout(() => {
        document.getElementById('errorMsg').textContent = '';
        document.getElementById('errorMsg').className = '';
      }, 3000);
    }

    function rotateGroupInternally(group) {
      // è¿‡æ»¤å‡ºéç©ºçš„å­¦ç”Ÿåå­—
      const nonEmptyStudents = group.filter(name => name !== '');
      const emptyCount = group.length - nonEmptyStudents.length;

      // å¦‚æœæ²¡æœ‰å­¦ç”Ÿæˆ–åªæœ‰ä¸€ä¸ªå­¦ç”Ÿï¼Œç›´æ¥è¿”å›åŸæ•°ç»„
      if (nonEmptyStudents.length <= 1) {
        return group;
      }

      // è½®è½¬éç©ºå­¦ç”Ÿåå­—
      const firstStudent = nonEmptyStudents[0];
      const rotatedStudents = [...nonEmptyStudents.slice(1), firstStudent];

      // åœ¨æœ«å°¾æ·»åŠ ç©ºä½
      return [...rotatedStudents, ...Array(emptyCount).fill('')];
    }

    function handleSeatChange(groupIndex, seatIndex, value) {
      if (isEditMode) {
        groups[groupIndex][seatIndex] = value;
      }
    }

    function rotateRowGroups() {
      // å¯¹æ¯ä¸€æ’çš„å·¦å³å°ç»„åˆ†åˆ«è¿›è¡Œç»„å†…è½®è½¬
      rowGroups.rows.forEach(row => {
        // è½®è½¬å·¦è¾¹å°ç»„
        const leftNonEmpty = row.left.filter(name => name !== '');
        if (leftNonEmpty.length > 1) {
          const rotatedLeft = [...leftNonEmpty.slice(1), leftNonEmpty[0]];
          row.left = [...rotatedLeft, ...Array(7 - rotatedLeft.length).fill('')];
        }

        // è½®è½¬å³è¾¹å°ç»„
        const rightNonEmpty = row.right.filter(name => name !== '');
        if (rightNonEmpty.length > 1) {
          const rotatedRight = [...rightNonEmpty.slice(1), rightNonEmpty[0]];
          row.right = [...rotatedRight, ...Array(7 - rotatedRight.length).fill('')];
        }
      });

      // è½®è½¬æ’çš„é¡ºåºï¼ˆè¡Œæ•°æ®å’Œé¢œè‰²ä¸€èµ·è½®è½¬ï¼‰
      const temp = rowGroups.rows[0];
      rowGroups.rows[0] = rowGroups.rows[1];
      rowGroups.rows[1] = rowGroups.rows[2];
      rowGroups.rows[2] = temp;

      // é¢œè‰²ä¹Ÿè·Ÿç€è½¬ï¼š6ä¸ªä½ç½®æŒ‰å·¦å³æ’åˆ— [ç¬¬1æ’å·¦, ç¬¬1æ’å³, ç¬¬2æ’å·¦, ç¬¬2æ’å³, ç¬¬3æ’å·¦, ç¬¬3æ’å³]
      // æ’è½®è½¬æ—¶ï¼šç¬¬1æ’â†’ç¬¬3æ’, ç¬¬2æ’â†’ç¬¬1æ’, ç¬¬3æ’â†’ç¬¬2æ’
      const c = rowGroups.colorOrder;
      rowGroups.colorOrder = [c[2], c[3], c[4], c[5], c[0], c[1]];
    }

    function refreshSeating() {
      const classroom = document.getElementById('classroom');
      classroom.innerHTML = '';

      if (currentLayout === 'circular') {
        refreshCircularSeating();
      } else if (currentLayout === 'rows') {
        classroom.className = 'classroom three-rows-layout';
        refreshRowSeating();
      } else if (currentLayout === 'arc') {
        classroom.className = 'classroom arc-layout';
        refreshArcSeating();
      }
    }

    function refreshCircularSeating() {
      const classroom = document.getElementById('classroom');
      const mapping = getRotationMapping();

      for (let tableIndex = 0; tableIndex < 6; tableIndex++) {
        const groupIndex = mapping[tableIndex];

        const table = document.createElement('div');
        table.className = `table group-${groupIndex + 1}`;

        // è®¡ç®—è¿™ä¸ªç»„ä¸­æœ€é•¿åå­—çš„é•¿åº¦
        const maxNameLength = Math.max(...groups[groupIndex].filter(name => name).map(name => name.length), 1);
        // æ ¹æ®æœ€é•¿åå­—çš„é•¿åº¦åŠ¨æ€è®¡ç®—å­—ä½“å¤§å°
        const fontSize = Math.min(16, Math.max(10, Math.floor(140 / maxNameLength)));

        let tableHtml = `<h3>Group ${tableIndex + 1}</h3>`;
        tableHtml += '<div class="seats">';

        for (let seatIndex = 0; seatIndex < 6; seatIndex++) {
          const student = groups[groupIndex][seatIndex] || '';
          tableHtml += `
                        <div class="seat">
                            <input type="text"
                                value="${student}"
                                style="font-size: ${fontSize}px"
                                ${!isEditMode ? 'readonly' : ''}
                                onchange="handleSeatChange(${groupIndex}, ${seatIndex}, this.value)"
                            >
                        </div>
                    `;
        }

        tableHtml += '</div>';
        table.innerHTML = tableHtml;
        classroom.appendChild(table);
      }
    }

    function refreshRowSeating() {
      const classroom = document.getElementById('classroom');
      classroom.className = 'classroom three-rows-layout';

      const rowNames = ['ç¬¬ä¸€æ’', 'ç¬¬äºŒæ’', 'ç¬¬ä¸‰æ’'];

      // 6ç§ç»„èƒŒæ™¯è‰²ï¼ˆå’Œåœ†æ¡Œä¸€è‡´ï¼‰
      const groupColors = {
        1: '#fff3b0', 2: '#a8d5ff', 3: '#ffb74d',
        4: '#b3e5fc', 5: '#c8e6c9', 6: '#ffd1dc'
      };

      // ç¡®ä¿ colorOrder å­˜åœ¨
      if (!rowGroups.colorOrder) rowGroups.colorOrder = [1, 2, 3, 4, 5, 6];

      rowGroups.rows.forEach((row, rowIndex) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'row-table-wrapper';

        // å·¦ä¾§"ç¬¬Xæ’"æ ‡ç­¾
        const label = document.createElement('div');
        label.className = 'row-label';
        label.textContent = rowNames[rowIndex];
        wrapper.appendChild(label);

        // ç»Ÿè®¡å·¦å³éç©ºåº§ä½
        const leftStudents = row.left.filter(s => s);
        const rightStudents = row.right.filter(s => s);
        const leftCount = leftStudents.length;
        const rightCount = rightStudents.length;

        // è·å–é¢œè‰²
        const leftColorId = rowGroups.colorOrder[rowIndex * 2];
        const rightColorId = rowGroups.colorOrder[rowIndex * 2 + 1];
        const leftBg = groupColors[leftColorId] || '#f5f5f5';
        const rightBg = groupColors[rightColorId] || '#f5f5f5';

        // æ„å»ºè¡¨æ ¼
        const table = document.createElement('table');
        table.className = 'row-table';

        // è¡¨å¤´è¡Œï¼šå·¦1 å·¦2 ... | é—´éš” | å³N å³N-1 ... å³1
        let headerHtml = '<tr>';
        for (let i = 0; i < leftCount; i++) {
          headerHtml += `<th style="background:${leftBg}">å·¦${i + 1}</th>`;
        }
        headerHtml += '<th class="gap-col"></th>';
        for (let i = rightCount; i >= 1; i--) {
          headerHtml += `<th style="background:${rightBg}">å³${i}</th>`;
        }
        headerHtml += '</tr>';

        // å†…å®¹è¡Œï¼šå­¦ç”Ÿåå­—
        let bodyHtml = '<tr>';
        row.left.forEach((student, seatIndex) => {
          if (student) {
            bodyHtml += `<td style="background:${leftBg}">
              <input type="text" value="${student}"
                ${!isEditMode ? 'readonly' : ''}
                onchange="handleRowSeatChange(${rowIndex}, 'left', ${seatIndex}, this.value)">
            </td>`;
          }
        });
        bodyHtml += '<td class="gap-col"></td>';
        row.right.forEach((student, seatIndex) => {
          if (student) {
            bodyHtml += `<td style="background:${rightBg}">
              <input type="text" value="${student}"
                ${!isEditMode ? 'readonly' : ''}
                onchange="handleRowSeatChange(${rowIndex}, 'right', ${seatIndex}, this.value)">
            </td>`;
          }
        });
        bodyHtml += '</tr>';

        table.innerHTML = headerHtml + bodyHtml;
        wrapper.appendChild(table);
        classroom.appendChild(wrapper);
      });
    }

    function refreshArcSeating() {
      const classroom = document.getElementById('classroom');

      const colors = ['#fff3b0', '#a8d5ff'];

      arcGroups.rows.forEach((row, rowIndex) => {
        const rowElement = document.createElement('div');
        rowElement.className = 'arc-row';
        rowElement.style.background = colors[rowIndex % colors.length];

        const seats = document.createElement('div');
        seats.className = 'arc-seats';

        const maxNameLength = Math.max(...row.filter(name => name).map(name => name.length), 1);
        const baseFontSize = Math.min(16, Math.max(12, Math.floor(140 / maxNameLength)));

        const n = row.length; // 18
        const center = (n - 1) / 2; // 8.5
        const maxOffset = 20; // å¼§å½¢é«˜åº¦

        for (let i = 0; i < row.length; i++) {
          const student = row[i] || '';
          const seat = document.createElement('div');
          seat.className = 'seat arc-seat';

          // ä»åº•éƒ¨åŸºçº¿å¼€å§‹ï¼Œä¸­é—´å‘ä¸Šå‡¸èµ·å½¢æˆå¼§å½¢
          const distanceFromCenter = Math.abs(i - center);
          const radius = center; // åŠåœ†åŠå¾„
          const upwardOffset = distanceFromCenter <= radius ? Math.round(Math.sqrt(radius * radius -
            distanceFromCenter * distanceFromCenter) * (maxOffset / radius)) : 0;
          seat.style.marginBottom = upwardOffset + 'px';
          seat.style.display = 'inline-block';
          seat.style.verticalAlign = 'bottom';

          const input = document.createElement('input');
          input.type = 'text';
          input.value = student;
          input.style.fontSize = baseFontSize + 'px';
          if (!isEditMode) input.setAttribute('readonly', 'readonly');
          input.onchange = (e) => handleArcSeatChange(rowIndex, i, e.target.value);
          seat.appendChild(input);
          seats.appendChild(seat);
        }

        rowElement.appendChild(seats);
        classroom.appendChild(rowElement);
      });
    }

    function handleRowSeatChange(rowIndex, side, seatIndex, value) {
      if (isEditMode) {
        rowGroups.rows[rowIndex][side][seatIndex] = value;
      }
    }

    function handleArcSeatChange(rowIndex, seatIndex, value) {
      if (isEditMode) {
        arcGroups.rows[rowIndex][seatIndex] = value;
      }
    }

    function rotateArcLayout() {
      // å¯¹æ¯æ’çš„å­¦ç”Ÿè¿›è¡Œå†…éƒ¨è½®æ¢ï¼ˆç¬¬ä¸€ä¸ªç§»åˆ°æœ€åï¼‰
      arcGroups.rows.forEach((row, rowIndex) => {
        const nonEmpty = row.filter(name => name !== '');
        if (nonEmpty.length > 1) {
          const rotated = [...nonEmpty.slice(1), nonEmpty[0]];
          const newRow = Array(18).fill('');
          placeCentered(newRow, rotated);
          arcGroups.rows[rowIndex] = newRow;
        }
      });
    }

    function generateSeating() {
      if (isEditMode) {
        refreshSeating();
        return;
      }

      if (currentLayout === 'circular') {
        const newGroups = groups.map(group => [...group]);
        for (let i = 0; i < newGroups.length; i++) {
          newGroups[i] = rotateGroupInternally(newGroups[i]);
        }
        groups = newGroups;
      } else if (currentLayout === 'rows') {
        rotateRowGroups();
      } else if (currentLayout === 'arc') {
        rotateArcLayout();
      }

      const activeCount = getActiveGroupIndices().length;
      currentArrangement = (currentArrangement + 1) % activeCount;
      refreshSeating();

      // ä¿å­˜æ›´æ–°
      const className = document.getElementById('classSelect').value;
      if (className && classData[className]) {
        classData[className][currentTimeMode] = {
          layout: currentLayout,
          groups: currentLayout === 'circular' ? JSON.parse(JSON.stringify(groups)) : null,
          rowGroups: currentLayout === 'rows' ? JSON.parse(JSON.stringify(rowGroups)) : null,
          arcGroups: currentLayout === 'arc' ? JSON.parse(JSON.stringify(arcGroups)) : null,
          currentArrangement: currentArrangement,
          locationInfo: getLocationInfo()
        };
        localStorage.setItem('classSeatingData', JSON.stringify(classData));
      }
    }

    function toggleEditMode() {
      isEditMode = !isEditMode;
      const editButton = document.querySelector('.edit-mode button');
      editButton.textContent = isEditMode ? 'é€€å‡ºç¼–è¾‘' : 'ç¼–è¾‘æ¨¡å¼';
      editButton.style.background = isEditMode ? '#f44336' : '#2196F3';
      refreshSeating();
    }

    // æ–‡æœ¬å¯¹é½åŠŸèƒ½
    function setTextAlign(align) {
      document.execCommand('justify' + align.charAt(0).toUpperCase() + align.slice(1), false, null);
      updateAlignButtons();
    }

    function setVerticalAlign(align) {
      const selection = window.getSelection();
      if (!selection.rangeCount) return;

      const range = selection.getRangeAt(0);
      const selectedElement = range.commonAncestorContainer;

      if (selectedElement.nodeType === 3) { // æ–‡æœ¬èŠ‚ç‚¹
        const span = document.createElement('span');
        span.style.verticalAlign = align;
        range.surroundContents(span);
      } else if (selectedElement.nodeType === 1) { // å…ƒç´ èŠ‚ç‚¹
        selectedElement.style.verticalAlign = align;
      }

      updateAlignButtons();
    }

    function updateAlignButtons() {
      const buttons = document.querySelectorAll('.text-align-group button');
      buttons.forEach(button => button.classList.remove('active'));

      // è·å–å½“å‰é€‰ä¸­æ–‡æœ¬çš„å¯¹é½æ–¹å¼
      const alignment = document.queryCommandState('justifyLeft') ? 'left' :
        document.queryCommandState('justifyCenter') ? 'center' :
        document.queryCommandState('justifyRight') ? 'right' : '';

      if (alignment) {
        const activeButton = document.querySelector(`[onclick*="setTextAlign('${alignment}')"]`);
        if (activeButton) activeButton.classList.add('active');
      }
    }

    // å¤„ç†å›¾ç‰‡ç²˜è´´
    document.getElementById('notes').addEventListener('paste', function (e) {
      e.preventDefault();
      const items = (e.clipboardData || e.originalEvent.clipboardData).items;

      for (let item of items) {
        if (item.type.indexOf('image') === 0) {
          const blob = item.getAsFile();
          const reader = new FileReader();

          reader.onload = function (event) {
            const img = document.createElement('img');
            img.src = event.target.result;
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            img.style.resize = 'both';
            img.style.overflow = 'auto';
            img.style.border = '1px solid #ddd';
            img.style.margin = '10px auto';
            img.style.display = 'block';

            // ä½¿å›¾ç‰‡å¯è°ƒæ•´å¤§å°
            img.addEventListener('mousedown', function (e) {
              if (e.target.style.resize === 'both') {
                e.target.contentEditable = true;
              }
            });

            document.getElementById('notes').appendChild(img);
          };
          reader.readAsDataURL(blob);
        } else if (item.type === 'text/plain') {
          item.getAsString(function (text) {
            document.execCommand('insertText', false, text);
          });
        }
      }
    });

    function updateTime() {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      if (document.getElementById('time').value === '') {
        document.getElementById('time').value = `${hours}:${minutes}`;
      }
    }

    // ç›‘å¬å¸ƒå±€é€‰æ‹©å˜åŒ–
    document.getElementById('circularLayout').addEventListener('change', updateLayoutDescription);
    document.getElementById('rowsLayout').addEventListener('change', updateLayoutDescription);
    document.getElementById('arcLayout').addEventListener('change', updateLayoutDescription);

    function updateLayoutDescription() {
      const layoutDesc = document.getElementById('layoutDescription');
      const isCircular = document.getElementById('circularLayout').checked;
      const isRows = document.getElementById('rowsLayout').checked;
      const isArc = document.getElementById('arcLayout').checked;

      if (isCircular) {
        layoutDesc.innerHTML = `
                    <ul style="font-size: 14px; color: #666; margin: 10px 0;">
                        <li>31-36äººï¼š6ä¸ªå°ç»„</li>
                        <li>25-30äººï¼š5ä¸ªå°ç»„</li>
                        <li>19-24äººï¼š4ä¸ªå°ç»„ï¼ˆç¬¬1ã€2ã€3ã€5ç»„ï¼‰</li>
                        <li>1-18äººï¼š3ä¸ªå°ç»„ï¼ˆç¬¬1ã€2ã€3ç»„ï¼‰</li>
                    </ul>
                `;
      } else if (isRows) {
        layoutDesc.innerHTML = `
                    <ul style="font-size: 14px; color: #666; margin: 10px 0;">
                        <li>å­¦ç”Ÿå°†è¢«å¹³å‡åˆ†é…åˆ°ä¸‰æ’</li>
                        <li>æ¯æ’åˆ†ä¸ºå·¦å³ä¸¤ä¸ªå°ç»„</li>
                        <li>å¦‚æœå•æ•°ï¼Œå·¦è¾¹å°ç»„å¤šä¸€äºº</li>
                    </ul>
                `;
      } else if (isArc) {
        layoutDesc.innerHTML = `
                    <ul style="font-size: 14px; color: #666; margin: 10px 0;">
                        <li>åœ†å¼§å¸ƒå±€ï¼šä¸¤æ’ï¼Œæ¯æ’18ä¸ªåº§ä½</li>
                        <li>å­¦ç”Ÿå°†å±…ä¸­å‘ä¸¤ä¾§æ‰©å±•</li>
                        <li>æ¯æ’æœ€å¤šå®¹çº³18äºº</li>
                    </ul>
                `;
      }
    }

    // ç›‘å¬å­—ä½“å¤§å°å’Œé¢œè‰²å˜åŒ–
    document.getElementById('noteFontSize').addEventListener('change', function (e) {
      document.execCommand('fontSize', false, '7');
      const elements = document.getElementsByTagName('font');
      for (let i = 0; i < elements.length; i++) {
        if (elements[i].size === '7') {
          elements[i].removeAttribute('size');
          elements[i].style.fontSize = e.target.value + 'px';
        }
      }
    });

    document.getElementById('noteColor').addEventListener('change', function (e) {
      document.execCommand('foreColor', false, e.target.value);
    });

    function showBatchImportDialog() {
      document.getElementById('batchImportDialog').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
      document.getElementById('batchImportError').textContent = '';
    }

    function hideBatchImportDialog() {
      document.getElementById('batchImportDialog').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    }

    function processBatchImport() {
      const text = document.getElementById('batchImportData').value;
      const classes = text.split('!').filter(c => c.trim()); // ç”¨!åˆ†éš”æ¯ä¸ªç­çº§
      let successCount = 0;
      let errorMessages = [];

      for (const classText of classes) {
        try {
          const lines = classText.split('\n').map(l => l.trim()).filter(l => l);
          const classInfo = {
            weekday: {
              date: '',
              day: '',
              weekday: '',
              time: '',
              layout: '',
              groups: null,
              rowGroups: null,
              students: []
            },
            weekend: {
              date: '',
              day: '',
              weekday: '',
              time: '',
              layout: '',
              groups: null,
              rowGroups: null,
              students: []
            }
          };
          let currentSection = '';
          let currentTimeMode = '';

          // è§£æåŸºæœ¬ä¿¡æ¯
          for (const line of lines) {
            if (line.startsWith('ç­çº§åç§°:')) {
              classInfo.name = line.split(':')[1].trim();
            } else if (line.startsWith('æ ¡åŒº:')) {
              classInfo.campus = line.split(':')[1].trim();
            } else if (line.startsWith('æ¥¼å±‚:')) {
              classInfo.floor = line.split(':')[1].trim();
            } else if (line.startsWith('æ•™å®¤:')) {
              classInfo.room = line.split(':')[1].trim();
            } else if (line.startsWith('å‘¨ä¸­å¸ƒå±€:')) {
              const layout = line.split(':')[1].trim();
              classInfo.weekday.layout = layout === 'åœ†æ¡Œ' ? 'circular' : layout === 'ä¸‰æ’' ? 'rows' : 'arc';
              currentTimeMode = 'weekday';
              currentSection = '';
            } else if (line.startsWith('å‘¨æœ«å¸ƒå±€:')) {
              const layout = line.split(':')[1].trim();
              classInfo.weekend.layout = layout === 'åœ†æ¡Œ' ? 'circular' : layout === 'ä¸‰æ’' ? 'rows' : 'arc';
              currentTimeMode = 'weekend';
              currentSection = '';
            } else if (line === 'å‘¨ä¸­æ—¶é—´:') {
              currentTimeMode = 'weekday';
            } else if (line === 'å‘¨æœ«æ—¶é—´:') {
              currentTimeMode = 'weekend';
            } else if (currentTimeMode && line.startsWith('æœˆ:')) {
              classInfo[currentTimeMode].date = line.split(':')[1].trim();
            } else if (currentTimeMode && line.startsWith('æ—¥:')) {
              classInfo[currentTimeMode].day = line.split(':')[1].trim();
            } else if (currentTimeMode && line.startsWith('æ˜ŸæœŸ:')) {
              classInfo[currentTimeMode].weekday = line.split(':')[1].trim();
            } else if (currentTimeMode && line.startsWith('æ—¶é—´:')) {
              // æ—¶é—´å¯èƒ½åŒ…å«å†’å·å¦‚ "14:30"ï¼Œå–ç¬¬ä¸€ä¸ªå†’å·åçš„å…¨éƒ¨å†…å®¹
              classInfo[currentTimeMode].time = line.substring(line.indexOf(':') + 1).trim();
            } else if (currentTimeMode && line.startsWith('Group')) {
              // å¤„ç†æ¯ä¸ªå°ç»„çš„å­¦ç”Ÿ
              const groupMatch = line.match(/Group (\d+):/);
              if (groupMatch) {
                const groupIndex = parseInt(groupMatch[1]) - 1;
                const students = line.substring(line.indexOf(':') + 1)
                  .split(',')
                  .map(s => s.trim())
                  .filter(s => s);

                // æ ¹æ®å½“å‰æ¨¡å¼çš„å¸ƒå±€åˆå§‹åŒ–æ•°æ®ç»“æ„
                if (!classInfo[currentTimeMode].groups && classInfo[currentTimeMode].layout === 'circular') {
                  classInfo[currentTimeMode].groups = Array(6).fill().map(() => Array(6).fill(''));
                }
                if (!classInfo[currentTimeMode].rowGroups && classInfo[currentTimeMode].layout === 'rows') {
                  classInfo[currentTimeMode].rowGroups = {
                    rows: Array(3).fill().map(() => ({
                      left: Array(7).fill(''),
                      right: Array(7).fill('')
                    }))
                  };
                }
                if (!classInfo[currentTimeMode].groups && classInfo[currentTimeMode].layout === 'arc') {
                  classInfo[currentTimeMode].groups = Array(2).fill().map(() => Array(18).fill(''));
                }

                if (classInfo[currentTimeMode].layout === 'circular') {
                  // åœ†æ¡Œå¸ƒå±€
                  students.forEach((student, index) => {
                    if (index < 6) {
                      classInfo[currentTimeMode].groups[groupIndex][index] = student;
                    }
                  });
                } else if (classInfo[currentTimeMode].layout === 'rows') {
                  // ä¸‰æ’å¸ƒå±€
                  const rowIndex = Math.floor(groupIndex / 2);
                  const isRight = groupIndex % 2 === 1;
                  if (rowIndex < 3) {
                    const side = isRight ? 'right' : 'left';
                    students.forEach((student, index) => {
                      if (index < 7) {
                        classInfo[currentTimeMode].rowGroups.rows[rowIndex][side][index] = student;
                      }
                    });
                  }
                } else if (classInfo[currentTimeMode].layout === 'arc') {
                  // åœ†å¼§å¸ƒå±€
                  const rowIndex = Math.floor(groupIndex / 2);
                  const isFirstRow = groupIndex % 2 === 0;
                  if (rowIndex < 2) {
                    students.forEach((student, index) => {
                      if (index < 18) {
                        classInfo[currentTimeMode].groups[rowIndex][index] = student;
                      }
                    });
                  }
                }
              }
            }
          }

          // éªŒè¯æ•°æ®
          if (!classInfo.name) {
            throw new Error('ç¼ºå°‘ç­çº§åç§°');
          }
          if (!classInfo.weekday.layout && !classInfo.weekend.layout) {
            throw new Error('è‡³å°‘éœ€è¦ä¸€ä¸ªå¸ƒå±€é…ç½®ï¼ˆå‘¨ä¸­æˆ–å‘¨æœ«ï¼‰');
          }

          // åˆ›å»ºç­çº§é…ç½®
          if (!classData[classInfo.name]) {
            classData[classInfo.name] = {
              weekday: {
                layout: 'circular',
                groups: null,
                rowGroups: null,
                currentArrangement: 0,
                locationInfo: {}
              },
              weekend: {
                layout: 'circular',
                groups: null,
                rowGroups: null,
                currentArrangement: 0,
                locationInfo: {}
              }
            };
          }

          // æ›´æ–°ç­çº§é…ç½®
          ['weekday', 'weekend'].forEach(timeMode => {
            if (classInfo[timeMode].layout) { // åªæ›´æ–°æœ‰å¸ƒå±€é…ç½®çš„æ—¶é—´æ¨¡å¼
              classData[classInfo.name][timeMode] = {
                layout: classInfo[timeMode].layout,
                groups: classInfo[timeMode].groups,
                rowGroups: classInfo[timeMode].rowGroups,
                currentArrangement: 0,
                locationInfo: {
                  campus: classInfo.campus || '',
                  floor: classInfo.floor || '',
                  room: classInfo.room || '',
                  date: classInfo[timeMode].date || '',
                  day: classInfo[timeMode].day || '',
                  weekday: classInfo[timeMode].weekday || '',
                  time: classInfo[timeMode].time || '',
                  notes: ''
                }
              };
            }
          });

          successCount++;
        } catch (e) {
          errorMessages.push(`ç­çº§ ${classText.split('\n')[0].split(':')[1]?.trim() || 'æœªçŸ¥'}: ${e.message}`);
        }
      }

      // ä¿å­˜åˆ°localStorage
      localStorage.setItem('classSeatingData', JSON.stringify(classData));
      updateClassSelect();

      // æ˜¾ç¤ºç»“æœ
      const errorDiv = document.getElementById('batchImportError');
      if (errorMessages.length > 0) {
        errorDiv.innerHTML = `æˆåŠŸå¯¼å…¥ ${successCount} ä¸ªç­çº§ï¼Œ${errorMessages.length} ä¸ªå¤±è´¥ï¼š<br>` +
          errorMessages.map(msg => `â€¢ ${msg}`).join('<br>');
        errorDiv.className = 'error';
      } else {
        errorDiv.textContent = `æˆåŠŸå¯¼å…¥ ${successCount} ä¸ªç­çº§é…ç½®ï¼`;
        errorDiv.className = 'success';
        setTimeout(hideBatchImportDialog, 2000);
      }
    }

    function toggleLayout() {
      const classroom = document.getElementById('classroom');
      if (currentLayout === 'circular') {
        const students = collectStudentsFromCircular();
        convertStudentsToRows(students);
        currentLayout = 'rows';
        currentArrangement = 0;
        classroom.className = 'classroom three-rows-layout';
        refreshSeating();
      } else if (currentLayout === 'rows') {
        const students = collectStudentsFromRows();
        if (students.length > 36) {
          alert('åœ†æ¡Œå¸ƒå±€æœ€å¤šæ”¯æŒ36äººï¼Œå½“å‰å…±æœ‰ ' + students.length + ' äºº');
          return;
        }
        convertStudentsToCircular(students);
        currentLayout = 'circular';
        currentArrangement = 0;
        classroom.className = 'classroom';
        refreshSeating();
      } else if (currentLayout === 'arc') {
        const students = collectStudentsFromArc();
        if (students.length > 36) {
          alert('åœ†å¼§å¸ƒå±€æœ€å¤šæ”¯æŒ36äººï¼ˆæ¯æ’æœ€å¤š18äººï¼‰ï¼Œå½“å‰å…±æœ‰ ' + students.length + ' äºº');
          return;
        }
        convertStudentsToCircular(students);
        currentLayout = 'circular';
        currentArrangement = 0;
        classroom.className = 'classroom';
        refreshSeating();
      }

      // ä¿å­˜å½“å‰å¸ƒå±€ä¸æ•°æ®
      const className = document.getElementById('classSelect').value;
      if (className) {
        if (!classData[className]) {
          classData[className] = {
            weekday: {
              layout: currentLayout,
              groups: null,
              rowGroups: null,
              currentArrangement: 0,
              locationInfo: {}
            },
            weekend: {
              layout: currentLayout,
              groups: null,
              rowGroups: null,
              currentArrangement: 0,
              locationInfo: {}
            }
          };
        }
        classData[className][currentTimeMode] = {
          layout: currentLayout,
          groups: currentLayout === 'circular' ? JSON.parse(JSON.stringify(groups)) : null,
          rowGroups: currentLayout === 'rows' ? JSON.parse(JSON.stringify(rowGroups)) : null,
          arcGroups: currentLayout === 'arc' ? JSON.parse(JSON.stringify(arcGroups)) : null,
          currentArrangement: currentArrangement,
          locationInfo: getLocationInfo()
        };
        localStorage.setItem('classSeatingData', JSON.stringify(classData));
      }
    }

    // æ”¶é›†å½“å‰åœ†æ¡Œå¸ƒå±€çš„éç©ºå­¦ç”Ÿï¼ŒæŒ‰ç»„åºä¸åº§ä½åº
    function collectStudentsFromCircular() {
      const list = [];
      for (let g = 0; g < groups.length; g++) {
        for (let s = 0; s < groups[g].length; s++) {
          const name = groups[g][s];
          if (name && name.trim()) list.push(name.trim());
        }
      }
      return list;
    }

    // æ”¶é›†å½“å‰ä¸‰æ’å¸ƒå±€çš„éç©ºå­¦ç”Ÿï¼ŒæŒ‰è¡Œã€å·¦ã€å³çš„é¡ºåº
    function collectStudentsFromRows() {
      const list = [];
      rowGroups.rows.forEach(row => {
        row.left.forEach(name => {
          if (name && name.trim()) list.push(name.trim());
        });
        row.right.forEach(name => {
          if (name && name.trim()) list.push(name.trim());
        });
      });
      return list;
    }

    // æ”¶é›†å½“å‰åœ†å¼§å¸ƒå±€çš„éç©ºå­¦ç”Ÿï¼ŒæŒ‰æ’åºä¸åº§ä½åº
    function collectStudentsFromArc() {
      const list = [];
      arcGroups.rows.forEach(row => {
        row.forEach(name => {
          if (name && name.trim()) list.push(name.trim());
        });
      });
      return list;
    }

    // å°†å­¦ç”Ÿåˆ†é…åˆ°ä¸‰æ’å¸ƒå±€ï¼ˆå°½é‡å¹³å‡ï¼Œæ¯æ’å·¦å³åˆ†é…ï¼Œå·¦å¤šä¸€äººï¼‰
    function convertStudentsToRows(students) {
      const total = students.length;
      rowGroups.rows = Array(3).fill().map(() => ({
        left: Array(7).fill(''),
        right: Array(7).fill('')
      }));
      rowGroups.colorOrder = [1, 2, 3, 4, 5, 6];
      const studentsPerRow = Math.ceil(total / 3);
      let idx = 0;
      for (let row = 0; row < 3; row++) {
        const thisRow = Math.min(studentsPerRow, total - row * studentsPerRow);
        const leftCount = Math.ceil(thisRow / 2);
        const rightCount = thisRow - leftCount;
        for (let i = 0; i < leftCount && idx < total && i < 7; i++) {
          rowGroups.rows[row].left[i] = students[idx++];
        }
        for (let i = 0; i < rightCount && idx < total && i < 7; i++) {
          rowGroups.rows[row].right[i] = students[idx++];
        }
      }
    }

    // å°†å­¦ç”Ÿåˆ†é…åˆ°åœ†æ¡Œå¸ƒå±€ï¼Œä½¿ç”¨åŠ¨æ€ç»„æ•°è§„åˆ™
    function convertStudentsToCircular(students) {
      const total = students.length;
      const numGroups = calcNumGroups(total);
      const groupIndices = getGroupIndicesForCount(numGroups);
      groups = Array(6).fill().map(() => Array(6).fill(''));
      let idx = 0;
      const base = Math.floor(total / numGroups);
      const extra = total % numGroups;
      for (let i = 0; i < numGroups; i++) {
        const g = groupIndices[i];
        const thisGroup = i < extra ? base + 1 : base;
        for (let s = 0; s < thisGroup && idx < total && s < 6; s++) {
          groups[g][s] = students[idx++];
        }
      }
    }

    // åˆå§‹åŒ–
    loadSavedData();
    updateTime();
    setInterval(updateTime, 60000);
    refreshSeating();
  </script>
</body>

</html>